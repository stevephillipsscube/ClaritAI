<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Get_Update_Fees</name>
        <label>Get Update Fees</label>
        <locationX>440</locationX>
        <locationY>792</locationY>
        <actionName>MUSW__GetFeesFromTemplatesAction</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Go_through_outstanding_fees</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>templates</name>
            <value>
                <elementReference>feetemplatecollection</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>relatedRecordId</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputParameters>
        <nameSegment>MUSW__GetFeesFromTemplatesAction</nameSegment>
        <outputParameters>
            <assignToReference>Updatedfeesfromapex</assignToReference>
            <name>fees</name>
        </outputParameters>
    </actionCalls>
    <apiVersion>59.0</apiVersion>
    <assignments>
        <name>Add_Fee_template_to_a_collection</name>
        <label>Add Fee template to a collection</label>
        <locationX>528</locationX>
        <locationY>600</locationY>
        <assignmentItems>
            <assignToReference>feetemplatecollection</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>feetemplate</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_Fee_Template_from_Fees</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_fee_to_collection</name>
        <label>Add fee to collection</label>
        <locationX>704</locationX>
        <locationY>1332</locationY>
        <assignmentItems>
            <assignToReference>feecollection</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>fee</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Fees_from_Apex</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Fee_Templates_assignment</name>
        <label>Fee Templates assignment</label>
        <locationX>528</locationX>
        <locationY>492</locationY>
        <assignmentItems>
            <assignToReference>feetemplate.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Fee_Template_from_Fees.Fee_Template__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Fee_template_to_a_collection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Update_amount_for_fee_found</name>
        <label>Update amount for fee found</label>
        <locationX>704</locationX>
        <locationY>1224</locationY>
        <assignmentItems>
            <assignToReference>fee.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Go_through_outstanding_fees.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>fee.MUSW__Amount__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Fees_from_Apex.MUSW__Amount__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_fee_to_collection</targetReference>
        </connector>
    </assignments>
    <collectionProcessors>
        <name>Filter_to_match_outstanding_fees_from_apex_action</name>
        <elementSubtype>FilterCollectionProcessor</elementSubtype>
        <label>Filter to match outstanding fees from apex action</label>
        <locationX>616</locationX>
        <locationY>1008</locationY>
        <assignNextValueToReference>currentItem_Filter_to_match_outstanding_fees_from_apex_action</assignNextValueToReference>
        <collectionProcessorType>FilterCollectionProcessor</collectionProcessorType>
        <collectionReference>Updatedfeesfromapex</collectionReference>
        <conditionLogic>and</conditionLogic>
        <conditions>
            <leftValueReference>currentItem_Filter_to_match_outstanding_fees_from_apex_action.Fee_Template__c</leftValueReference>
            <operator>EqualTo</operator>
            <rightValue>
                <elementReference>Go_through_outstanding_fees.Fee_Template__c</elementReference>
            </rightValue>
        </conditions>
        <connector>
            <targetReference>Fees_from_Apex</targetReference>
        </connector>
    </collectionProcessors>
    <environments>Default</environments>
    <interviewLabel>(Permit) - Recalculate Fees {!$Flow.CurrentDateTime}</interviewLabel>
    <label>(Permit) - Recalculate Fees</label>
    <loops>
        <name>Fees_from_Apex</name>
        <label>Fees from Apex</label>
        <locationX>616</locationX>
        <locationY>1116</locationY>
        <collectionReference>Filter_to_match_outstanding_fees_from_apex_action</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Update_amount_for_fee_found</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Go_through_outstanding_fees</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Get_Fee_Template_from_Fees</name>
        <label>Get Fee Template from Fees</label>
        <locationX>440</locationX>
        <locationY>384</locationY>
        <collectionReference>outstandingpermitfees</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Fee_Templates_assignment</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Get_Update_Fees</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Go_through_outstanding_fees</name>
        <label>Go through outstanding fees</label>
        <locationX>440</locationX>
        <locationY>900</locationY>
        <collectionReference>outstandingpermitfees</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Filter_to_match_outstanding_fees_from_apex_action</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Update_all_fees</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_Outstanding_Fees</name>
        <label>Get Outstanding Fees</label>
        <locationX>440</locationX>
        <locationY>276</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Fee_Template_from_Fees</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>MUSW__Permit2__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>MUSW__Outstanding_Fee__c</field>
            <operator>GreaterThan</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </filters>
        <object>MUSW__Fee__c</object>
        <outputReference>outstandingpermitfees</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>MUSW__Outstanding_Fee__c</queriedFields>
        <queriedFields>MUSW__Amount__c</queriedFields>
        <queriedFields>Fee_Template__c</queriedFields>
    </recordLookups>
    <recordUpdates>
        <name>Update_all_fees</name>
        <label>Update all fees</label>
        <locationX>440</locationX>
        <locationY>1608</locationY>
        <connector>
            <targetReference>Update_Recalculate_Fee_field</targetReference>
        </connector>
        <inputReference>feecollection</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Recalculate_Fee_field</name>
        <label>Update Recalculate Fee field</label>
        <locationX>440</locationX>
        <locationY>1716</locationY>
        <inputAssignments>
            <field>Recalculate_Fees__c</field>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>50</locationX>
        <locationY>0</locationY>
        <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Recalculate_Fees__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>MUSW__Permit2__c</object>
        <recordTriggerType>Update</recordTriggerType>
        <scheduledPaths>
            <connector>
                <targetReference>Get_Outstanding_Fees</targetReference>
            </connector>
            <pathType>AsyncAfterCommit</pathType>
        </scheduledPaths>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>currentItem_Filter_to_match_outstanding_fees_from_apex_action</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>MUSW__Fee__c</objectType>
    </variables>
    <variables>
        <name>fee</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>MUSW__Fee__c</objectType>
    </variables>
    <variables>
        <name>feecollection</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>MUSW__Fee__c</objectType>
    </variables>
    <variables>
        <name>feetemplate</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>MUSW__Master_Fee_List__c</objectType>
    </variables>
    <variables>
        <name>feetemplatecollection</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>MUSW__Master_Fee_List__c</objectType>
    </variables>
    <variables>
        <name>outstandingpermitfees</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>MUSW__Fee__c</objectType>
    </variables>
    <variables>
        <name>Updatedfeesfromapex</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>MUSW__Fee__c</objectType>
    </variables>
</Flow>
